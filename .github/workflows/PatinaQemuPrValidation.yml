# A reusable workflow that builds patina-dxe-core-qemu against the current PR head
# and validates boot on QEMU.
#
# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: Apache-2.0
##
name: Patina QEMU PR Validation

on:
  workflow_call:
    inputs:
      pr-number:
        description: "Pull request number in the caller repository"
        required: true
        type: number
      patina-ref:
        description: "Commit/branch/tag to checkout in patina"
        required: true
        type: string

permissions:
  contents: read
  actions: read

jobs:
  vars:
    name: Get Constants
    uses: OpenDevicePartnership/patina-qemu/.github/workflows/qemu-constants.yml@main

  readiness:
    name: Check Readiness
    runs-on: ubuntu-latest
    if: github.repository_owner == 'OpenDevicePartnership'
    steps:
      - name: Checkout patina
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.patina-ref }}

      - name: Check Major Version Compatibility
        id: compare
        shell: bash
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import re
          import tomllib
          import urllib.request

          # Get the major version in Cargo.toml in the patina repo
          patina_cargo_toml_text = pathlib.Path('Cargo.toml').read_text(encoding='utf-8')
          patina_cargo_data = tomllib.loads(patina_cargo_toml_text)
          patina_local_version = patina_cargo_data['workspace']['package']['version']
          patina_local_major = int(patina_local_version.split('.')[0])

          # Get the major version from the latest GitHub release in the patina repo
          with urllib.request.urlopen('https://api.github.com/repos/OpenDevicePartnership/patina/releases/latest') as response:
              patina_latest_gh_release = json.loads(response.read().decode('utf-8'))

          patina_latest_tag = patina_latest_gh_release['tag_name']
          patina_latest_major_tag_match = re.search(r'(\d+)', patina_latest_tag)

          if patina_latest_major_tag_match is None:
              raise SystemExit(f'Unable to parse latest release major from tag: {patina_latest_tag}')

          patina_latest_major_tag = int(patina_latest_major_tag_match.group(1))

          # Get the major version in Cargo.toml in patina-dxe-core-qemu/main
          with urllib.request.urlopen('https://raw.githubusercontent.com/OpenDevicePartnership/patina-dxe-core-qemu/refs/heads/main/Cargo.toml') as response:
              patina_dxe_core_qemu_cargo_text = response.read().decode('utf-8')

          patina_dxe_core_qemu_cargo_toml = tomllib.loads(patina_dxe_core_qemu_cargo_text)

          patina_dxe_core_qemu_dep = None
          if 'dependencies' in patina_dxe_core_qemu_cargo_toml and 'patina' in patina_dxe_core_qemu_cargo_toml['dependencies']:
              patina_dxe_core_qemu_dep = patina_dxe_core_qemu_cargo_toml['dependencies']['patina']
          else:
              raise SystemExit('Unable to locate the patina crate dependency in patina-dxe-core-qemu Cargo.toml')

          if isinstance(patina_dxe_core_qemu_dep, str):
              patina_dxe_core_qemu_dep_version = patina_dxe_core_qemu_dep
          elif isinstance(patina_dxe_core_qemu_dep, dict):
              patina_dxe_core_qemu_dep_version = patina_dxe_core_qemu_dep.get('version', '')
          else:
              patina_dxe_core_qemu_dep_version = ''

          dep_major_match = re.search(r'(\d+)', patina_dxe_core_qemu_dep_version)
          if dep_major_match is None:
              raise SystemExit(f'Unable to parse patina dependency major ver from: {patina_dxe_core_qemu_dep_version}')
          patina_dxe_core_qemu_dep_major = int(dep_major_match.group(1))

          mismatch = patina_local_major != patina_dxe_core_qemu_dep_major
          output_file = pathlib.Path(os.environ['GITHUB_OUTPUT'])
          with output_file.open('a', encoding='utf-8') as out:
              out.write(f'patina_local_version={patina_local_version}\n')
              out.write(f'patina_local_major={patina_local_major}\n')
              out.write(f'patina_latest_tag={patina_latest_tag}\n')
              out.write(f'patina_latest_major_tag={patina_latest_major_tag}\n')
              out.write(f'patina_dxe_core_qemu_dep_version={patina_dxe_core_qemu_dep_version}\n')
              out.write(f'patina_dxe_core_qemu_dep_major={patina_dxe_core_qemu_dep_major}\n')
              out.write(f'mismatch={str(mismatch).lower()}\n')
          PY

      - name: Comment on Major Version Mismatch
        if: steps.compare.outputs.mismatch == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const marker = '*This comment was automatically generated by the patina-qemu-pr-validation workflow.*';
            const issue_number = Number('${{ inputs.pr-number }}');

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
            });

            const alreadyCommented = comments.data.some((comment) =>
              comment.body.includes(marker) && comment.body.includes('patina-dxe-core-qemu needs updated')
            );

            if (!alreadyCommented) {
              const body = [
                '## QEMU Readiness Check Failed',
                '',
                'patina-dxe-core-qemu needs updated before QEMU validation can run.',
                '',
                `- Latest patina release major version: \`${{ steps.compare.outputs.latest_major }}\` (tag: \`${{ steps.compare.outputs.latest_tag }}\`)`,
                `- patina dependency in patina-dxe-core-qemu: \`${{ steps.compare.outputs.qemu_patina_version }}\` (major: \`${{ steps.compare.outputs.qemu_patina_major }}\`)`,
                '',
                marker,
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body,
              });
            }

      - name: Fail Due to Major Version Mismatch
        if: steps.compare.outputs.mismatch == 'true'
        shell: bash
        run: |
          echo "Patina QEMU validation failed due to major version mismatch in patina and patina-dxe-core-qemu."
          exit 1

  validate-qemu-linux:
    name: Validate QEMU (Linux)
    runs-on: ubuntu-latest
    needs: [vars, readiness]
    container: ${{ needs.vars.outputs['container-image'] }}

    steps:
      - name: Checkout patina
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.patina-ref }}

      - name: Setup Python (Linux container)
        shell: bash
        run: |
          python3 --version

      - name: Download Rust Tools
        uses: OpenDevicePartnership/patina-devops/.github/actions/rust-tool-cache@main

      - name: Clone Dependencies
        shell: bash
        run: |
          git clone https://github.com/OpenDevicePartnership/patina-dxe-core-qemu.git
          git clone https://github.com/OpenDevicePartnership/patina-fw-patcher.git

      - name: Identify Latest patina-qemu FW Release Binaries
        id: patina-qemu-release-assets
        shell: bash
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import urllib.request

          with urllib.request.urlopen('https://api.github.com/repos/OpenDevicePartnership/patina-qemu/releases/latest') as response:
              release = json.loads(response.read().decode('utf-8'))

          tag = release['tag_name']
          q35_name = f'patina-qemu-q35-{tag}.zip'
          sbsa_name = f'patina-qemu-sbsa-{tag}.zip'

          assets = {asset['name']: asset['browser_download_url'] for asset in release.get('assets', [])}
          if q35_name not in assets:
              raise SystemExit(f'Missing expected Q35 firmware asset: {q35_name}')
          if sbsa_name not in assets:
              raise SystemExit(f'Missing expected SBSA firmware asset: {sbsa_name}')

          output_file = pathlib.Path(os.environ['GITHUB_OUTPUT'])
          with output_file.open('a', encoding='utf-8') as out:
              out.write(f'tag={tag}\n')
              out.write(f'q35_url={assets[q35_name]}\n')
              out.write(f'sbsa_url={assets[sbsa_name]}\n')
          PY

      - name: Check Cache For patina-qemu FW Binaries
        id: firmware-cache
        uses: actions/cache@v5
        with:
          path: |
            .cache/patina-qemu/q35.zip
            .cache/patina-qemu/sbsa.zip
          key: patina-qemu-fw-${{ runner.os }}-${{ steps.patina-qemu-release-assets.outputs.tag }}

      - name: Download patina-qemu FW Binaries
        if: steps.firmware-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          mkdir -p .cache/patina-qemu
          curl -L "${{ steps.patina-qemu-release-assets.outputs.q35_url }}" -o .cache/patina-qemu/q35.zip
          curl -L "${{ steps.patina-qemu-release-assets.outputs.sbsa_url }}" -o .cache/patina-qemu/sbsa.zip

      - name: Extract patina-qemu FW Binaries
        shell: bash
        run: |
          mkdir -p firmware
          unzip -o .cache/patina-qemu/q35.zip -d firmware
          unzip -o .cache/patina-qemu/sbsa.zip -d firmware

      - name: Build patina-dxe-core-qemu with PR Changes in the patina PR
        shell: bash
        run: |
          cd patina-dxe-core-qemu
          cargo make q35 -- --crate-patch "$GITHUB_WORKSPACE" --leave-patch
          cargo make q35-release
          cargo make sbsa
          cargo make sbsa-release

      - name: Fetch Patina QEMU Build and Patch Script
        shell: bash
        run: |
          curl -L "https://raw.githubusercontent.com/OpenDevicePartnership/patina-qemu/refs/heads/main/build_and_run_rust_binary.py" -o patina-dxe-core-qemu/build_and_run_rust_binary.py
          chmod +x patina-dxe-core-qemu/build_and_run_rust_binary.py

      - name: Patch and Run Changes on QEMU Linux
        shell: bash
        env:
          SHUTDOWN_AFTER_RUN: 'TRUE'
          QEMU_HEADLESS: 'TRUE'
          QEMU_CORE_NUM: ${{ needs.vars.outputs['qemu-core-count'] }}
        run: |
          set -o pipefail
          mkdir -p logs
          cd patina-dxe-core-qemu
          python3 ./build_and_run_rust_binary.py \
            --patina-dxe-core-repo "$GITHUB_WORKSPACE/patina-dxe-core-qemu" \
            --fw-patch-repo "$GITHUB_WORKSPACE/patina-fw-patcher" \
            --pre-compiled-rom "$GITHUB_WORKSPACE/firmware/Q35/DEBUG-GCC5/QEMUQ35_CODE.fd" \
            --build-target DEBUG \
            --toolchain "${{ needs.vars.outputs['linux-toolchain'] }}" \
            --platform Q35 \
            2>&1 | tee ../logs/q35-linux.log
          python3 ./build_and_run_rust_binary.py \
            --patina-dxe-core-repo "$GITHUB_WORKSPACE/patina-dxe-core-qemu" \
            --fw-patch-repo "$GITHUB_WORKSPACE/patina-fw-patcher" \
            --pre-compiled-rom "$GITHUB_WORKSPACE/firmware/SBSA/DEBUG-GCC5/QEMU_EFI.fd" \
            --build-target DEBUG \
            --toolchain "${{ needs.vars.outputs['linux-toolchain'] }}" \
            --platform SBSA \
            2>&1 | tee ../logs/sbsa-linux.log

      - name: Upload QEMU Linux Logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: qemu-validation-logs-${{ runner.os }}
          path: logs/*
          if-no-files-found: warn

  validate-qemu-windows:
    name: Validate QEMU (Windows)
    runs-on: windows-latest
    needs: [vars, readiness]
    steps:
      - name: Checkout patina
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.patina-ref }}

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ needs.vars.outputs['python-version'] }}

      - name: Download Rust Tools
        uses: OpenDevicePartnership/patina-devops/.github/actions/rust-tool-cache@main

      - name: Clone Dependencies
        shell: bash
        run: |
          git clone https://github.com/OpenDevicePartnership/patina-dxe-core-qemu.git
          git clone https://github.com/OpenDevicePartnership/patina-fw-patcher.git

      - name: Identify Latest patina-qemu FW Release Binaries
        id: patina-qemu-release-assets
        shell: bash
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import urllib.request

          with urllib.request.urlopen('https://api.github.com/repos/OpenDevicePartnership/patina-qemu/releases/latest') as response:
              release = json.loads(response.read().decode('utf-8'))

          tag = release['tag_name']
          q35_name = f'patina-qemu-q35-{tag}.zip'
          sbsa_name = f'patina-qemu-sbsa-{tag}.zip'

          assets = {asset['name']: asset['browser_download_url'] for asset in release.get('assets', [])}
          if q35_name not in assets:
              raise SystemExit(f'Missing expected Q35 firmware asset: {q35_name}')
          if sbsa_name not in assets:
              raise SystemExit(f'Missing expected SBSA firmware asset: {sbsa_name}')

          output_file = pathlib.Path(os.environ['GITHUB_OUTPUT'])
          with output_file.open('a', encoding='utf-8') as out:
              out.write(f'tag={tag}\n')
              out.write(f'q35_url={assets[q35_name]}\n')
              out.write(f'sbsa_url={assets[sbsa_name]}\n')
          PY

      - name: Check Cache For patina-qemu FW Binaries
        id: firmware-cache
        uses: actions/cache@v5
        with:
          path: |
            .cache/patina-qemu/q35.zip
            .cache/patina-qemu/sbsa.zip
          key: patina-qemu-fw-${{ runner.os }}-${{ steps.patina-qemu-release-assets.outputs.tag }}

      - name: Download patina-qemu FW Binaries
        if: steps.firmware-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path .cache\patina-qemu -Force | Out-Null
          Invoke-WebRequest -Uri "${{ steps.patina-qemu-release-assets.outputs.q35_url }}" -OutFile ".cache\patina-qemu\q35.zip"
          Invoke-WebRequest -Uri "${{ steps.patina-qemu-release-assets.outputs.sbsa_url }}" -OutFile ".cache\patina-qemu\sbsa.zip"

      - name: Extract patina-qemu FW Binaries
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path firmware -Force | Out-Null
          Expand-Archive -Path .cache\patina-qemu\q35.zip -DestinationPath firmware -Force
          Expand-Archive -Path .cache\patina-qemu\sbsa.zip -DestinationPath firmware -Force

      - name: Build patina-dxe-core-qemu with PR Changes in the patina PR
        shell: bash
        run: |
          cd patina-dxe-core-qemu
          cargo make q35 -- --crate-patch "$GITHUB_WORKSPACE" --leave-patch
          cargo make q35-release
          cargo make sbsa
          cargo make sbsa-release

      - name: Fetch Patina QEMU Build and Patch Script
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/OpenDevicePartnership/patina-qemu/refs/heads/main/build_and_run_rust_binary.py" -OutFile "patina-dxe-core-qemu/build_and_run_rust_binary.py"

      - name: Resolve Windows QEMU package
        id: windows-qemu
        shell: pwsh
        run: |
          $yamlPath = Join-Path $env:RUNNER_TEMP "qemu-windows_ext_dep.yaml"
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/OpenDevicePartnership/patina-qemu/refs/heads/main/QemuPkg/Binaries/qemu-windows_ext_dep.yaml" -OutFile $yamlPath
          $text = Get-Content -Path $yamlPath -Raw
          $zipUrl = ([regex]::Match($text, 'https?://[^\s\"\'']+\.zip')).Value
          if (-not $zipUrl) { throw "Unable to find QEMU zip URL in qemu-windows_ext_dep.yaml" }
          "zip-url=$zipUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Check Cache For Windows QEMU Package
        id: qemu-cache
        uses: actions/cache@v5
        with:
          path: .cache/qemu/windows-qemu.zip
          key: windows-qemu-${{ steps.windows-qemu.outputs.zip-url }}

      - name: Download the Windows QEMU Package
        if: steps.qemu-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path .cache\qemu -Force | Out-Null
          Invoke-WebRequest -Uri "${{ steps.windows-qemu.outputs.zip-url }}" -OutFile ".cache\qemu\windows-qemu.zip"

      - name: Extract and Add Windows QEMU to PATH
        id: qemu-path
        shell: pwsh
        run: |
          Expand-Archive -Path ".cache\qemu\windows-qemu.zip" -DestinationPath ".cache\qemu\windows" -Force
          $exe = Get-ChildItem -Path ".cache\qemu\windows" -Filter "qemu-system-x86_64.exe" -Recurse | Select-Object -First 1
          if (-not $exe) { throw "qemu-system-x86_64.exe not found after extracting Windows QEMU package" }
          $dir = $exe.DirectoryName
          "$dir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "qemu_path=$dir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Patch and Run Changes on QEMU Windows
        shell: pwsh
        env:
          SHUTDOWN_AFTER_RUN: 'TRUE'
          QEMU_HEADLESS: 'TRUE'
          QEMU_CORE_NUM: ${{ needs.vars.outputs['qemu-core-count'] }}
        run: |
          New-Item -ItemType Directory -Path logs -Force | Out-Null
          Push-Location patina-dxe-core-qemu
          try {
            python .\build_and_run_rust_binary.py `
              --patina-dxe-core-repo "$env:GITHUB_WORKSPACE\patina-dxe-core-qemu" `
              --fw-patch-repo "$env:GITHUB_WORKSPACE\patina-fw-patcher" `
              --pre-compiled-rom "$env:GITHUB_WORKSPACE\firmware\Q35\DEBUG-VS2022\QEMUQ35_CODE.fd" `
              --qemu-path "${{ steps.qemu-path.outputs.qemu_path }}" `
              --build-target DEBUG `
              --toolchain "${{ needs.vars.outputs['windows-toolchain'] }}" `
              --platform Q35 *>&1 | Tee-Object -FilePath ..\logs\q35-windows.log
            if ($LASTEXITCODE -ne 0) {
              throw "QEMU run failed for Q35 on Windows"
            }
          }
          finally {
            Pop-Location
          }

      - name: Upload QEMU Windows Logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: qemu-validation-logs-${{ runner.os }}
          path: logs/*
          if-no-files-found: warn

  comment-on-failure:
    name: Comment on PR Failure
    runs-on: ubuntu-latest
    needs: [validate-qemu-linux, validate-qemu-windows]
    if: failure()
    steps:
      - name: Post failure comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const issue_number = Number('${{ inputs.pr-number }}');
            const marker = '*This comment was automatically generated by the patina-qemu-pr-validation workflow.*';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = [
              '## QEMU Validation Failed',
              '',
              'QEMU validation did not complete successfully or did not shutdown as expected.',
              '',
              '- Logs are available in workflow artifacts for this run.',
              `- Workflow run: ${runUrl}`,
              '',
              marker,
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body,
            });
