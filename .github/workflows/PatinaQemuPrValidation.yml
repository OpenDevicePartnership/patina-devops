# A reusable workflow that builds patina-dxe-core-qemu against the current PR head
# and validates boot on QEMU.
#
# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: Apache-2.0
##
name: Patina QEMU PR Validation

on:
  workflow_call:
    inputs:
      pr-number:
        description: "Pull request number in the caller repository"
        required: true
        type: number
      patina-ref:
        description: "Commit/branch/tag to checkout in patina"
        required: true
        type: string

permissions:
  contents: read
  actions: read

jobs:
  vars:
    name: Get Constants
    uses: OpenDevicePartnership/patina-qemu/.github/workflows/qemu-constants.yml@main

  readiness:
    name: Check Readiness
    runs-on: ubuntu-latest
    if: github.repository_owner == 'OpenDevicePartnership'
    outputs:
      patina_local_version: ${{ steps.compare.outputs.patina_local_version }}
      patina_local_major: ${{ steps.compare.outputs.patina_local_major }}
      patina_latest_tag: ${{ steps.compare.outputs.patina_latest_tag }}
      patina_latest_major_tag: ${{ steps.compare.outputs.patina_latest_major_tag }}
      patina_dxe_core_qemu_dep_version: ${{ steps.compare.outputs.patina_dxe_core_qemu_dep_version }}
      patina_dxe_core_qemu_dep_major: ${{ steps.compare.outputs.patina_dxe_core_qemu_dep_major }}
      mismatch: ${{ steps.compare.outputs.mismatch }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.patina-ref }}

      - name: Check Major Version Compatibility
        id: compare
        shell: bash
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import re
          import tomllib
          import urllib.request

          # Get the major version in Cargo.toml in the patina repo
          patina_cargo_toml_text = pathlib.Path('Cargo.toml').read_text(encoding='utf-8')
          patina_cargo_data = tomllib.loads(patina_cargo_toml_text)
          patina_local_version = patina_cargo_data['workspace']['package']['version']
          patina_local_major = int(patina_local_version.split('.')[0])

          # Get the major version from the latest GitHub release in the patina repo
          with urllib.request.urlopen('https://api.github.com/repos/OpenDevicePartnership/patina/releases/latest') as response:
              patina_latest_gh_release = json.loads(response.read().decode('utf-8'))

          patina_latest_tag = patina_latest_gh_release['tag_name']
          patina_latest_major_tag_match = re.search(r'(\d+)', patina_latest_tag)

          if patina_latest_major_tag_match is None:
              raise SystemExit(f'Unable to parse latest release major from tag: {patina_latest_tag}')

          patina_latest_major_tag = int(patina_latest_major_tag_match.group(1))

          # Get the major version in Cargo.toml in patina-dxe-core-qemu/main
          with urllib.request.urlopen('https://raw.githubusercontent.com/OpenDevicePartnership/patina-dxe-core-qemu/refs/heads/main/Cargo.toml') as response:
              patina_dxe_core_qemu_cargo_text = response.read().decode('utf-8')

          patina_dxe_core_qemu_cargo_toml = tomllib.loads(patina_dxe_core_qemu_cargo_text)

          patina_dxe_core_qemu_dep = None
          if 'dependencies' in patina_dxe_core_qemu_cargo_toml and 'patina' in patina_dxe_core_qemu_cargo_toml['dependencies']:
              patina_dxe_core_qemu_dep = patina_dxe_core_qemu_cargo_toml['dependencies']['patina']
          else:
              raise SystemExit('Unable to locate the patina crate dependency in patina-dxe-core-qemu Cargo.toml')

          if isinstance(patina_dxe_core_qemu_dep, str):
              patina_dxe_core_qemu_dep_version = patina_dxe_core_qemu_dep
          elif isinstance(patina_dxe_core_qemu_dep, dict):
              patina_dxe_core_qemu_dep_version = patina_dxe_core_qemu_dep.get('version', '')
          else:
              patina_dxe_core_qemu_dep_version = ''

          dep_major_match = re.search(r'(\d+)', patina_dxe_core_qemu_dep_version)
          if dep_major_match is None:
              raise SystemExit(f'Unable to parse patina dependency major ver from: {patina_dxe_core_qemu_dep_version}')
          patina_dxe_core_qemu_dep_major = int(dep_major_match.group(1))

          mismatch = patina_local_major != patina_dxe_core_qemu_dep_major
          output_file = pathlib.Path(os.environ['GITHUB_OUTPUT'])
          with output_file.open('a', encoding='utf-8') as out:
              out.write(f'patina_local_version={patina_local_version}\n')
              out.write(f'patina_local_major={patina_local_major}\n')
              out.write(f'patina_latest_tag={patina_latest_tag}\n')
              out.write(f'patina_latest_major_tag={patina_latest_major_tag}\n')
              out.write(f'patina_dxe_core_qemu_dep_version={patina_dxe_core_qemu_dep_version}\n')
              out.write(f'patina_dxe_core_qemu_dep_major={patina_dxe_core_qemu_dep_major}\n')
              out.write(f'mismatch={str(mismatch).lower()}\n')
          PY

      - name: Fail Due to Major Version Mismatch
        if: steps.compare.outputs.mismatch == 'true'
        shell: bash
        run: |
          echo "Patina QEMU validation failed due to major version mismatch in patina and patina-dxe-core-qemu."
          exit 1

  release-assets:
    name: Identify Latest patina-qemu FW Release Binaries
    runs-on: ubuntu-latest
    needs: [readiness]
    outputs:
      tag: ${{ steps.patina-qemu-release-assets.outputs.tag }}
      q35_url: ${{ steps.patina-qemu-release-assets.outputs.q35_url }}
      sbsa_url: ${{ steps.patina-qemu-release-assets.outputs.sbsa_url }}
    steps:
      - name: Identify Latest patina-qemu FW Release Binaries
        id: patina-qemu-release-assets
        shell: bash
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import urllib.request

          with urllib.request.urlopen('https://api.github.com/repos/OpenDevicePartnership/patina-qemu/releases/latest') as response:
              release = json.loads(response.read().decode('utf-8'))

          tag = release['tag_name']
          q35_name = f'patina-qemu-q35-{tag}.zip'
          sbsa_name = f'patina-qemu-sbsa-{tag}.zip'

          assets = {asset['name']: asset['browser_download_url'] for asset in release.get('assets', [])}
          if q35_name not in assets:
              raise SystemExit(f'Missing expected Q35 firmware asset: {q35_name}')
          if sbsa_name not in assets:
              raise SystemExit(f'Missing expected SBSA firmware asset: {sbsa_name}')

          output_file = pathlib.Path(os.environ['GITHUB_OUTPUT'])
          with output_file.open('a', encoding='utf-8') as out:
              out.write(f'tag={tag}\n')
              out.write(f'q35_url={assets[q35_name]}\n')
              out.write(f'sbsa_url={assets[sbsa_name]}\n')
          PY

  validate-qemu-linux:
    name: Validate QEMU (Linux)
    runs-on: ubuntu-latest
    needs: [vars, readiness, release-assets]
    container: ${{ needs.vars.outputs['container-image'] }}

    steps:
      - name: Checkout patina
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.patina-ref }}

      - name: Setup Python (Linux)
        shell: bash
        run: |
          python3 --version

      - name: Download Rust tools
        uses: OpenDevicePartnership/patina-devops/.github/actions/rust-tool-cache@main

      - name: Check Cache For patina-qemu FW Binaries
        id: firmware-cache
        uses: actions/cache@v5
        with:
          path: |
            .cache/patina-qemu/q35.zip
            .cache/patina-qemu/sbsa.zip
          key: patina-qemu-fw-${{ runner.os }}-${{ needs.release-assets.outputs.tag }}

      - name: Download patina-qemu FW binaries
        if: steps.firmware-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          mkdir -p .cache/patina-qemu
          curl -L "${{ needs.release-assets.outputs.q35_url }}" -o .cache/patina-qemu/q35.zip
          curl -L "${{ needs.release-assets.outputs.sbsa_url }}" -o .cache/patina-qemu/sbsa.zip

      - name: Extract patina-qemu FW binaries
        shell: bash
        run: |
          mkdir -p firmware
          unzip -o .cache/patina-qemu/q35.zip -d firmware
          unzip -o .cache/patina-qemu/sbsa.zip -d firmware

      - name: Setup and Build patina-dxe-core-qemu
        uses: OpenDevicePartnership/patina-devops/.github/actions/setup-patina-qemu-validation@main
        with:
          patina-repo-path: ${{ github.workspace }}

      - name: Patch and Run Changes on QEMU Linux
        shell: bash
        env:
          SHUTDOWN_AFTER_RUN: 'TRUE'
          QEMU_HEADLESS: 'TRUE'
          QEMU_CORE_NUM: ${{ needs.vars.outputs['qemu-core-count'] }}
        run: |
          set -o pipefail
          mkdir -p logs
          cd patina-dxe-core-qemu
          python3 ./build_and_run_rust_binary.py \
            --patina-dxe-core-repo "$GITHUB_WORKSPACE/patina-dxe-core-qemu" \
            --fw-patch-repo "$GITHUB_WORKSPACE/patina-fw-patcher" \
            --pre-compiled-rom "$GITHUB_WORKSPACE/firmware/Q35/DEBUG-GCC5/QEMUQ35_CODE.fd" \
            --build-target DEBUG \
            --toolchain "${{ needs.vars.outputs['linux-toolchain'] }}" \
            --platform Q35 \
            2>&1 | tee ../logs/q35-linux.log
          python3 ./build_and_run_rust_binary.py \
            --patina-dxe-core-repo "$GITHUB_WORKSPACE/patina-dxe-core-qemu" \
            --fw-patch-repo "$GITHUB_WORKSPACE/patina-fw-patcher" \
            --pre-compiled-rom "$GITHUB_WORKSPACE/firmware/SBSA/DEBUG-GCC5/QEMU_EFI.fd" \
            --build-target DEBUG \
            --toolchain "${{ needs.vars.outputs['linux-toolchain'] }}" \
            --platform SBSA \
            2>&1 | tee ../logs/sbsa-linux.log

      - name: Upload QEMU Linux Logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: qemu-validation-logs-${{ runner.os }}
          path: logs/*
          if-no-files-found: warn

  validate-qemu-windows:
    name: Validate QEMU (Windows)
    runs-on: windows-latest
    needs: [vars, readiness, release-assets]
    steps:
      - name: Checkout patina
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.patina-ref }}

      - name: Setup Python (Windows)
        uses: actions/setup-python@v6
        with:
          python-version: ${{ needs.vars.outputs['python-version'] }}

      - name: Download Rust Tools
        uses: OpenDevicePartnership/patina-devops/.github/actions/rust-tool-cache@main

      - name: Check Cache For patina-qemu FW Binaries
        id: firmware-cache
        uses: actions/cache@v5
        with:
          path: |
            .cache/patina-qemu/q35.zip
            .cache/patina-qemu/sbsa.zip
          key: patina-qemu-fw-${{ runner.os }}-${{ needs.release-assets.outputs.tag }}

      - name: Download patina-qemu FW binaries
        if: steps.firmware-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path .cache\patina-qemu -Force | Out-Null
          Invoke-WebRequest -Uri "${{ needs.release-assets.outputs.q35_url }}" -OutFile ".cache\patina-qemu\q35.zip"
          Invoke-WebRequest -Uri "${{ needs.release-assets.outputs.sbsa_url }}" -OutFile ".cache\patina-qemu\sbsa.zip"

      - name: Extract patina-qemu FW binaries
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path firmware -Force | Out-Null
          Expand-Archive -Path .cache\patina-qemu\q35.zip -DestinationPath firmware -Force
          Expand-Archive -Path .cache\patina-qemu\sbsa.zip -DestinationPath firmware -Force

      - name: Setup and Build patina-dxe-core-qemu
        uses: OpenDevicePartnership/patina-devops/.github/actions/setup-patina-qemu-validation@main
        with:
          patina-repo-path: ${{ github.workspace }}

      - name: Resolve Windows QEMU Package
        id: windows-qemu
        shell: pwsh
        run: |
          $yamlPath = Join-Path $env:RUNNER_TEMP "qemu-windows_ext_dep.yaml"
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/OpenDevicePartnership/patina-qemu/refs/heads/main/QemuPkg/Binaries/qemu-windows_ext_dep.yaml" -OutFile $yamlPath
          $text = Get-Content -Path $yamlPath -Raw
          $zipUrl = ([regex]::Match($text, 'https?://[^\s\"\'']+\.zip')).Value
          if (-not $zipUrl) { throw "Unable to find QEMU zip URL in qemu-windows_ext_dep.yaml" }
          "zip-url=$zipUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Cache Windows QEMU Package
        id: qemu-cache
        uses: actions/cache@v5
        with:
          path: .cache/qemu/windows-qemu.zip
          key: windows-qemu-${{ steps.windows-qemu.outputs.zip-url }}

      - name: Download Windows QEMU Package
        if: steps.qemu-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path .cache\qemu -Force | Out-Null
          Invoke-WebRequest -Uri "${{ steps.windows-qemu.outputs.zip-url }}" -OutFile ".cache\qemu\windows-qemu.zip"

      - name: Extract Windows QEMU and Update PATH
        id: qemu-path
        shell: pwsh
        run: |
          Expand-Archive -Path ".cache\qemu\windows-qemu.zip" -DestinationPath ".cache\qemu\windows" -Force
          $exe = Get-ChildItem -Path ".cache\qemu\windows" -Filter "qemu-system-x86_64.exe" -Recurse | Select-Object -First 1
          if (-not $exe) { throw "qemu-system-x86_64.exe not found after extracting Windows QEMU package" }
          $dir = $exe.DirectoryName
          "$dir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "qemu_path=$dir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Patch and Run Changes on QEMU Linux
        shell: pwsh
        env:
          SHUTDOWN_AFTER_RUN: 'TRUE'
          QEMU_HEADLESS: 'TRUE'
          QEMU_CORE_NUM: ${{ needs.vars.outputs['qemu-core-count'] }}
        run: |
          New-Item -ItemType Directory -Path logs -Force | Out-Null
          Push-Location patina-dxe-core-qemu
          try {
            python .\build_and_run_rust_binary.py `
              --patina-dxe-core-repo "$env:GITHUB_WORKSPACE\patina-dxe-core-qemu" `
              --fw-patch-repo "$env:GITHUB_WORKSPACE\patina-fw-patcher" `
              --pre-compiled-rom "$env:GITHUB_WORKSPACE\firmware\Q35\DEBUG-VS2022\QEMUQ35_CODE.fd" `
              --qemu-path "${{ steps.qemu-path.outputs.qemu_path }}" `
              --build-target DEBUG `
              --toolchain "${{ needs.vars.outputs['windows-toolchain'] }}" `
              --platform Q35 *>&1 | Tee-Object -FilePath ..\logs\q35-windows.log
            if ($LASTEXITCODE -ne 0) {
              throw "QEMU run failed for Q35 on Windows"
            }
          }
          finally {
            Pop-Location
          }

      - name: Upload QEMU Windows Logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: qemu-validation-logs-${{ runner.os }}
          path: logs/*
          if-no-files-found: warn

  emit-pr-metadata:
    name: Emit PR Metadata
    runs-on: ubuntu-latest
    needs: [readiness, validate-qemu-linux, validate-qemu-windows]
    if: always()
    steps:
      - name: Write PR metadata
        shell: bash
        run: |
          mkdir -p metadata
          python - <<'PY'
          import json
          import pathlib

          readiness_result = '${{ needs.readiness.result }}'
          linux_result = '${{ needs.validate-qemu-linux.result }}'
          windows_result = '${{ needs.validate-qemu-windows.result }}'

          metadata = {
              'pr_number': ${{ inputs.pr-number }},
              'patina_ref': '${{ inputs.patina-ref }}',
              'readiness': {
                  'job_result': readiness_result,
                  'mismatch': '${{ needs.readiness.outputs.mismatch }}',
                  'patina_local_version': '${{ needs.readiness.outputs.patina_local_version }}',
                  'patina_local_major': '${{ needs.readiness.outputs.patina_local_major }}',
                  'patina_latest_tag': '${{ needs.readiness.outputs.patina_latest_tag }}',
                  'patina_latest_major_tag': '${{ needs.readiness.outputs.patina_latest_major_tag }}',
                  'patina_dxe_core_qemu_dep_version': '${{ needs.readiness.outputs.patina_dxe_core_qemu_dep_version }}',
                  'patina_dxe_core_qemu_dep_major': '${{ needs.readiness.outputs.patina_dxe_core_qemu_dep_major }}'
              },
              'validation': {
                  'linux_result': linux_result,
                  'windows_result': windows_result,
                  'failed': (
                      linux_result not in ('success', 'skipped') or
                      windows_result not in ('success', 'skipped') or
                      readiness_result != 'success'
                  )
              }
          }

          output_path = pathlib.Path('metadata/pr-metadata.json')
          output_path.write_text(json.dumps(metadata, indent=2), encoding='utf-8')
          PY

      - name: Upload PR metadata artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: patina-qemu-pr-metadata
          path: metadata/pr-metadata.json
          if-no-files-found: error
