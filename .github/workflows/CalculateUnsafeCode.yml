# A workflow to analyze unsafe code usage and generate badges
# to show the amount of unsafe code in the repository.
#
##
# Copyright (c) Microsoft Corporation.
#
# SPDX-License-Identifier: Apache-2.0
##
name: "Unsafe Code Analysis"

on:
  workflow_call:

jobs:
  analyze-unsafe-code:
    name: Analyze Unsafe Code Usage
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read

    steps:
      - name: ✅ Checkout Repository ✅
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Checkout patina-devops scripts
        uses: actions/checkout@v5
        with:
          repository: OpenDevicePartnership/patina-devops
          path: patina-devops-scripts
          sparse-checkout: |
            .github/scripts
          sparse-checkout-cone-mode: false

      - name: 🛠️ Download Rust Tools 🛠️
        uses: OpenDevicePartnership/patina-devops/.github/actions/rust-tool-cache@main

      - name: Run unsafe code analysis
        run: |
          count-unsafe . > unsafe_analysis_raw.json
          python3 patina-devops-scripts/.github/scripts/analyze_unsafe_code.py unsafe_analysis_raw.json . --github-summary

      - name: Update git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout the unsafe-code-badges branch
        run: |
          mkdir -p /tmp/badge-data
          mv badge_*.json unsafe_analysis.json /tmp/badge-data/

          git fetch origin

          if git ls-remote --exit-code --heads origin unsafe-code-badges; then
            git checkout -B unsafe-code-badges origin/unsafe-code-badges
          else
            git checkout -b unsafe-code-badges
          fi

          mv /tmp/badge-data/*.json .

      - name: Push badge data to the unsafe-code-badges branch
        run: |
          git add badge_*.json unsafe_analysis.json
          git commit -m "Update unsafe code analysis badges" || echo "No changes to commit"

          git push origin unsafe-code-badges
